<!DOCTYPE html>
<html lang="en">

<head>
    <% include ../partials/head %>
</head>

<body>
    <div class="container-fluid">
        <div class="card card-register mx-auto mt-5">
                <div class="card-body">
                    <h2>Register an Account</h2>
                    <br>

                    <form class="signup">
                        <div class="form-group">
                            <label for="exampleInputEmail1">Email address</label>
                            <input type="email" class="form-control" id="email-input" placeholder="Email">
                        </div>
                        <div class="form-group">
                            <label for="exampleInputPassword1">Password</label>
                            <input type="password" class="form-control" id="password-input" placeholder="Password">
                        </div>
                        <div class="form-group">
                            <label for="exampleInputPassword1">Name</label>
                            <input type="text" class="form-control" id="name-input" placeholder="Name">
                        </div>
                        <div class="form-group">
                            <label for="exampleInputPassword1">Age</label>
                            <input type="text" class="form-control" id="age-input" placeholder="Age">
                        </div>
                        <div class="form-group">
                            <label for="exampleInputPassword1">Zipcode</label>
                            <input type="text" class="form-control" id="zipcode-input" placeholder="Zipcode">
                        </div>
                        <div class="form-group">
                            <label for="exampleInputPassword1">Primary User</label>
                            <input type="checkbox" class="form-control" id="primUser-input">
                        </div>

                        <div style="display: none" id="alert" class="alert alert-danger" role="alert">
                            <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                            <span class="sr-only">Error:</span> <span class="msg"></span>
                        </div>
                        <button type="submit" class="btn btn-default">Sign Up</button>
                    </form>

                    <div class="text-center">
                    <a class="d-block small mt-3" href="login.html">Login Page</a>
                    <a class="d-block small" href="forgot-password.html">Forgot Password?</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {

            $('#primUser-input').click(function() {
                $("#primUser-input").toggleClass('checked');
            });

            // Getting references to our form and input
            var signUpForm = $("form.signup");
            var emailInput = $("input#email-input");
            var passwordInput = $("input#password-input");
            var nameInput = $("input#name-input");
            var ageInput = $("input#age-input");
            var zipcodeInput = $("input#zipcode-input");
            var primUserInput = $("input#primUser-input");

            // When the signup button is clicked, we validate the email and password are not blank
            signUpForm.on("submit", function(event) {
                event.preventDefault();
                var userData = {
                    email: emailInput.val().trim(),
                    password: passwordInput.val().trim(),
                    name: nameInput.val().trim(),
                    age: ageInput.val().trim(),
                    zipcode: zipcodeInput.val().trim(),
                };
                if ($('#primUser-input').hasClass('checked')) {
                    userData.primary_user = true;
                } else {
                    userData.primary_user = false;
                }

                if (!userData.email || !userData.password) {
                    return; //NEED TO ADD NOTICE TO USER
                }
                // If we have an email and password, run the signUpUser function
                signUpUser(userData.email, userData.password, userData.age, userData.zipcode, userData.name, userData.primary_user);

                emailInput.val("");
                passwordInput.val("");
                ageInput.val("");
                zipcodeInput.val("");
                nameInput.val("");
            });

            // Does a post to the signup route. If succesful, we are redirected to the members page
            // Otherwise we log any errors
            function signUpUser(email, password, age, zipcode, name, primary_user) {
                $.post("/api/signup", {
                    email: email,
                    password: password,
                    age: age,
                    zipcode: zipcode,
                    name: name,
                    primary_user: primary_user
                }).then(function(data) {
                window.location.replace(data);
                // If there's an error, handle it by throwing up a boostrap alert
                }).catch(handleLoginErr);
            }

            function handleLoginErr(err) {
                $("#alert .msg").text(err.responseJSON);
                $("#alert").fadeIn(500);
            }
        });
    </script>
  </body>

</html>